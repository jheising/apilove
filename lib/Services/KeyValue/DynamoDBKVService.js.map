{"version":3,"file":"DynamoDBKVService.js","sourceRoot":"","sources":["DynamoDBKVService.ts"],"names":[],"mappings":"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","sourcesContent":["import {KVService} from \"./KVService\";\nimport {isNil, get} from \"lodash\";\nimport * as aws from \"aws-sdk\";\nimport {APIConfig} from \"../../APIConfig\";\n\nexport class DynamoDBKVStorage extends KVService\n{\n    private static _dynamoClient;\n    static get dynamoClient() {\n        if (!DynamoDBKVStorage._dynamoClient) {\n            DynamoDBKVStorage._dynamoClient = new aws.DynamoDB();\n        }\n\n        return DynamoDBKVStorage._dynamoClient;\n    }\n\n    setValue(namespace:string, key:string, value:any, expirationInSeconds:number, done:(error?:Error) => void)\n    {\n        value = JSON.stringify(value);\n\n        let data: any = {\n            key: {\n                S: `${namespace}:${key}`\n            },\n            value: {\n                S: value\n            },\n            expires: {\n                N: \"-1\"\n            }\n        };\n\n        if (!isNil(expirationInSeconds) && expirationInSeconds != -1) {\n            data.expires.N = Math.round(Date.now() / 1000 + expirationInSeconds).toString();\n        }\n\n        DynamoDBKVStorage.dynamoClient.putItem({\n            Item: data,\n            TableName: APIConfig.DYNAMO_KV_STORAGE_TABLE_NAME,\n            ReturnConsumedCapacity: \"NONE\"\n        }, (error, data) => {\n            if(done)\n            {\n                done(error);\n            }\n        });\n    }\n\n    hasValue(namespace:string, key:string, done:(error?:Error, hasValue?:boolean) => void)\n    {\n        this.getValue(namespace, key, (error, value) => {\n            if(done)\n            {\n                done(error, !isNil(value));\n            }\n        });\n    }\n\n    getValue(namespace:string, key:string, done:(error?:Error, value?:any) => void)\n    {\n        DynamoDBKVStorage.dynamoClient.getItem({\n            Key: {\n                key: {\n                    S: `${namespace}:${key}`\n                }\n            },\n            TableName: APIConfig.DYNAMO_KV_STORAGE_TABLE_NAME,\n            ReturnConsumedCapacity: \"NONE\",\n            AttributesToGet: [\"value\", \"expires\"]\n        }, (error, data) => {\n            let value = get(data, \"Item.value.S\");\n\n            let expires = get(data, \"Item.expires.N\", -1);\n            if(expires > 0)\n            {\n                let now = Math.round(Date.now() / 1000);\n                if(expires <= now)\n                {\n                    value = undefined;\n                }\n            }\n\n            if(!isNil(value))\n            {\n                value = JSON.parse(value);\n            }\n\n            if(done)\n            {\n                done(null, value);\n            }\n        });\n    }\n\n    deleteValue(namespace:string, key:string, done:(error?:Error) => void)\n    {\n        DynamoDBKVStorage.dynamoClient.deleteItem({\n            Key: {\n                key: {\n                    S: `${namespace}:${key}`\n                }\n            },\n            TableName: APIConfig.DYNAMO_KV_STORAGE_TABLE_NAME,\n            ReturnConsumedCapacity: \"NONE\"\n        }, (error, data) => {\n            if(done)\n            {\n                done(error);\n            }\n        });\n    }\n\n    updateExpiration(namespace:string, key:string, expirationInSeconds:number, done:(error?:Error) => void)\n    {\n        DynamoDBKVStorage.dynamoClient.updateItem({\n            ExpressionAttributeNames: {\n                \"#AT\": \"expires\"\n            },\n            ExpressionAttributeValues: {\n                \":t\": {\n                    N: Math.round(Date.now() / 1000 + expirationInSeconds).toString()\n                }\n            },\n            Key: {\n                key: {\n                    S: `${namespace}:${key}`\n                }\n            },\n            ReturnValues: \"NONE\",\n            TableName: APIConfig.DYNAMO_KV_STORAGE_TABLE_NAME,\n            UpdateExpression: \"SET #AT = :t\"\n        }, (error, data) => {\n            if(done)\n            {\n                done(error);\n            }\n        });\n    }\n}"]}